# Development Docker Compose Override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
version: '3.8'

services:
  python-api:
    build:
      target: base  # Use base stage for faster dev builds
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - RELOAD=true
    volumes:
      - .:/app:cached  # Live code reloading
      - /app/.venv     # Exclude venv from sync for speed
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    ports:
      - "8001:8000"
      - "8080:8080"  # Debug port

  go-api:
    build:
      context: ./go-api
      dockerfile: Dockerfile.dev  # Development Dockerfile
    environment:
      - GIN_MODE=debug
      - LOG_LEVEL=DEBUG
    volumes:
      - ./go-api:/app:cached
    ports:
      - "8000:8000"
      - "8081:8081"  # Debug port

  dragonfly:
    environment:
      - DFLY_maxmemory=128mb  # Less memory for dev
    command: [
      "dragonfly",
      "--logtostderr",
      "--requirepass=",
      "--maxmemory=100mb",
      "--cache_mode"
    ]

  # Development tools
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-web-ui
    environment:
      - REDIS_HOSTS=local:dragonfly:6379
    ports:
      - "8082:8081"
    depends_on:
      - dragonfly
    networks:
      - video-api-network

  # File watcher for Go (optional)
  go-watcher:
    image: cosmtrek/air:latest
    container_name: go-hot-reload
    working_dir: /app
    volumes:
      - ./go-api:/app
    ports:
      - "8083:8000"
    command: ["air", "-c", ".air.toml"]
    profiles:
      - hot-reload
    networks:
      - video-api-network
